---
title: "Summary of the citizen initiatives and civic crowdfunding survey for BrusselsTogether" 
subtitle: "R code for reproducible research"
author: "Paramio J., Piette C., Heremans S., Comté F., Mercier A."
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    code_folding: hide
    fig_height: 5
    theme: simplex
    toc: yes
    toc_float: 
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE, warning = FALSE, echo = FALSE, out.width = "50%"}
# All defaults
library(knitr)
include_graphics("inputs/SolvayBS_logo.gif")
```

## Summary 

This document provides the R code used to summarize the market research done by students at ULB/Sovay Brussels School on citizen initiatives and, in particular, civic crowdfunding. This research originated from a need by BrusselsTogether to better understand the factors driving the success of their own civic crowdfunding platform.

The present document provides all of the code written in R in order for anyone to be able to check and reproduce the findings resulting from the online survey launched in April 2018 by the students.

The input files can be retrieved on our [Github page](https://github.com/antoinemercier82/BrusselsTogether-Mkg-Analytics-Solvay-BS-2018).

## Preparations 

```{r loading_packages, message = FALSE, warning = FALSE}
library(readr)
library(lubridate)
library(stringr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(hrbrthemes)
library(knitr)
library(kableExtra)
```

## Analysis

### Data

There are only two input files (`Citizen initiative.csv` and  `header_lookup.txt`) which can be retrieved from the Github page mentionned above.

```{r message = FALSE, warning = FALSE}
survey_df <- read_csv("inputs/Citizen initiative.csv")
header_lookup <- read_delim("inputs/header_lookup.txt", delim = ";")
names(survey_df) <- header_lookup$df_header
```


### Preprocessing

The preprocessing code is available below, although in order to improve the clarity of this document, **it is better to hide this code** (click on the `Hide` button on the right).

```{r message = FALSE}
# Dates preprocessing
survey_df$date <- str_replace(string = survey_df$date,
                              pattern = "M GMT.*$",
                              replacement = "M")

survey_df$date <- str_replace_all(string = survey_df$date,
                                  pattern = "/",
                                  replacement = "-")

survey_df$date <- ymd_hms(survey_df$date)

survey_df <- survey_df %>% 
                filter(date > "2018-04-27 20:00:00")

# Language preprocessing
lut_lang <- c("English" = "English",
              "Nederlands" = "Dutch",
              "Français" = "French")

survey_df$lang <- lut_lang[survey_df$lang]

# Grouping preprocessing
lut_group_eng <- c("Citizen with no active implication in a local citizen's initiative, social project or social organization." = "Citizen_not_active",
                   "Active member of a local citizen's initiative, social project or social organization." = "Active_member",
                   "Citizen with casual volonteering for a local citizen's initiative, social project or social organization." = "Citizen_casual_vol")

lut_group_nl <- c("Een burger die geen deel uitmaakt van een lokaal burgerinitiatief, een sociaal project of een sociale organisatie." = "Citizen_not_active",
                  "Een burger die occasioneel bijdraagt als vrijliger van een lokaal burgerinitiatief, een sociaal project of een sociale organisatie." = "Citizen_casual_vol",
                  "Een actief lid van een lokaal burgerinitiatief, van een sociaal project of een sociale organisatie." = "Active_member")

lut_group_fr <- c("Citoyen.ne sans appartenance à une initiative citoyenne locale, un projet social ou une organisation sociale." = "Citizen_not_active",
                  "Citoyen.ne contribuant de manière occasionnelle en tant que volontaire à une initiative citoyenne locale, un projet social ou une organisation sociale." = "Citizen_casual_vol",
                  "Membre actif d'une initiative citoyenne locale, d'un projet social ou d'une organisation sociale." = "Active_member")


survey_df$grouping_eng <- lut_group_eng[survey_df$grouping_eng]
survey_df$grouping_nl <- lut_group_nl[survey_df$grouping_nl]
survey_df$grouping_fr <- lut_group_fr[survey_df$grouping_fr]

# Entrepreuneurs interest preprocessing
lut_e_int_eng <- c("I am not interested in joining a civic crowdfunding platform." = "Not_interested",
                   "I could be interested to join a civic crowdfunding platform." = "Could_be_interested",
                   "I am ready to join a civic crowdfunding platform." = "Is_ready")

lut_e_int_nl <- c("Ik ben niet geinteresseerd bij het toetreden van een ‘civic crowdfunding’ platform." = "Not_interested",
                  "Ik zou geinteresseerd kunnen zijn in het toetreden van een ‘civic crowdfunding’ platform." = "Could_be_interested",
                  "Ik wil deel uitmaken van een ‘civic crowdfunding’ platform." = "Is_ready")

lut_e_int_fr <- c("Je ne suis pas intéressé.e par l'adhésion à une plateforme de crowdfunding citoyen." = "Not_interested",
                  "Je pourrais être intéressé.e par l'adhésion à une plateforme de crowdfunding citoyen." = "Could_be_interested",
                  "Je suis prêt.e à rejoindre une plateforme de crowdfunding citoyen." = "Is_ready")

survey_df$e_interest_eng <- lut_e_int_eng[survey_df$e_interest_eng]
survey_df$e_interest_nl <- lut_e_int_nl[survey_df$e_interest_nl]
survey_df$e_interest_fr <- lut_e_int_fr[survey_df$e_interest_fr]

# Likert scale questions preprocessing
lut_likert_nl <- c("Helemaal niet akkoord" = "Strongly disagree",
                   "Niet akkoord" = "Disagree",
                   "Geen mening" = "Neither agree nor disagree",
                   "Akkoord" = "Agree",
                   "Helemaal akkoord" = "Strongly agree",
                   "Helemaal niet akkoord" = "Strongly disagree",
                   "niet akkoord" = "Disagree",
                   "geen mening" = "Neither agree nor disagree",
                   "akkoord" = "Agree",
                   "helemaal akkoord" = "Strongly agree")

lut_likert_fr <- c("Pas du tout d'accord" = "Strongly disagree",
                   "Pas d'accord" = "Disagree",
                   "Sans opinion" = "Neither agree nor disagree",
                   "D'accord" = "Agree",
                   "Tout à fait d'accord" = "Strongly agree")

survey_df[] <- lapply(colnames(survey_df),
                      function(x) {
                        y <- survey_df[[x]]
                        if (str_detect(x, pattern = "^._.[0-9]_nl$")) {
                          y <- lut_likert_nl[y]
                          }
                        return(y)
                        })

survey_df[] <- lapply(colnames(survey_df),
                      function(x) {
                        y <- survey_df[[x]]
                        if (str_detect(x, pattern = "^._.[0-9]_fr$")) {
                          y <- lut_likert_fr[y]
                        }
                        return(y)
                      })

# Citizen interest preprocessing
lut_c_int_eng <- c("I am not interested in citizen's initiatives." = "Not_interested",
                   "I could be interested to fund a citizen's initiative." = "Could_be_interested_Fund",
                   "I could be interested to volunteer for a citizen's initiative." = "Could_be_interested_Vol",
                   "I am ready to fund a citizen's initiative." = "Is_ready_Fund",
                   "I am ready to volunteer for a citizen's initiative." = "Is_ready_Vol")

lut_c_int_nl <- c("Ik ben niet geinteresseerd door burgerinitiatieven" = "Not_interested",
                  "Ik zou eventueel geinteresseerd kunnen zijn door het financieel te ondersteunen van burgerinitiatieven" = "Could_be_interested_Fund",
                  "Ik zou eventueel geinteresseerd zijn om een vrijwillige bijdrage te leveren aan een burgerinitiatief" = "Could_be_interested_Vol",
                  "Ik ben klaar om burgerinitiatieven te financieren" = "Is_ready_Fund",
                  "Ik ben klaar om vrijwilig mee te draaien in een burgerinitiatief" = "Is_ready_Vol")

lut_c_int_fr <- c("Je ne suis pas intéressé.e par les initiatives citoyennes" = "Not_interested",
                  "Je pourrais être éventuellement intéressé.e par le financement d'une initiative citoyenne" = "Could_be_interested_Fund",
                  "Je pourrais être éventuellement intéressé.e par une contribution en tant que volontaire dans une initiative citoyenne" = "Could_be_interested_Vol",
                  "Je suis prêt.e à financer une initiative citoyenne" = "Is_ready_Fund",
                  "Je suis prêt.e à contribuer en tant que volontaire dans une initiative citoyenne" = "Is_ready_Vol")

survey_df$c_interest_eng <- lut_c_int_eng[survey_df$c_interest_eng]
survey_df$c_interest_nl <- lut_c_int_nl[survey_df$c_interest_nl]
survey_df$c_interest_fr <- lut_c_int_fr[survey_df$c_interest_fr]

# Citizen already investing question preprocessing
lut_c_invest_eng <- c("0\u20AC" = "0",
                      "1 - 99\u20AC /year" = "1_99",
                      "100 - 199\u20AC /year" = "100_199",
                      "200 - 499\u20AC /year" = "200_499",
                      "500\u20AC + /year" = "500_plus")

lut_c_invest_nl <- c("0€" = "0",
                     "1 - 99€ /jaar" = "1_99",
                     "100 - 199€ /jaar" = "100_199",
                     "200 - 499€ /jaar" = "200_499",
                     "500€ + /jaar" = "500_plus")

lut_c_invest_fr <- c("0€" = "0",
                     "1 - 99€ /an" = "1_99",
                     "100 - 199€ /an" = "100_199",
                     "200 - 499€ /an" = "200_499",
                     "500€ + /an" = "500_plus")

# survey_df$c_invest_eng <- lut_c_invest_eng[survey_df$c_invest_eng]
# survey_df$c_invest_nl <- lut_c_invest_nl[survey_df$c_invest_nl]
# survey_df$c_invest_fr <- lut_c_invest_fr[survey_df$c_invest_fr]

replace_amount <- function(x, a, b) {
  mask <- str_detect(x, pattern = paste0("^", a))
  x[which(mask)] <- b
  return(x)
}

survey_df$c_invest_eng <- replace_amount(survey_df$c_invest_eng,
                                         a = "0",
                                         b = "0")
survey_df$c_invest_eng <- replace_amount(survey_df$c_invest_eng,
                                         a = "1 ",
                                         b = "1_99")
survey_df$c_invest_eng <- replace_amount(survey_df$c_invest_eng,
                                         a = "10",
                                         b = "100_199")
survey_df$c_invest_eng <- replace_amount(survey_df$c_invest_eng,
                                         a = "2",
                                         b = "200_499")
survey_df$c_invest_eng <- replace_amount(survey_df$c_invest_eng,
                                         a = "5",
                                         b = "500_plus")


survey_df$c_invest_nl <- replace_amount(survey_df$c_invest_nl,
                                         a = "0",
                                         b = "0")
survey_df$c_invest_nl <- replace_amount(survey_df$c_invest_nl,
                                         a = "1 ",
                                         b = "1_99")
survey_df$c_invest_nl <- replace_amount(survey_df$c_invest_nl,
                                         a = "10",
                                         b = "100_199")
survey_df$c_invest_nl <- replace_amount(survey_df$c_invest_nl,
                                         a = "2",
                                         b = "200_499")
survey_df$c_invest_nl <- replace_amount(survey_df$c_invest_nl,
                                         a = "5",
                                         b = "500_plus")


survey_df$c_invest_fr <- replace_amount(survey_df$c_invest_fr,
                                         a = "0",
                                         b = "0")
survey_df$c_invest_fr <- replace_amount(survey_df$c_invest_fr,
                                         a = "1 ",
                                         b = "1_99")
survey_df$c_invest_fr <- replace_amount(survey_df$c_invest_fr,
                                         a = "10",
                                         b = "100_199")
survey_df$c_invest_fr <- replace_amount(survey_df$c_invest_fr,
                                         a = "2",
                                         b = "200_499")
survey_df$c_invest_fr <- replace_amount(survey_df$c_invest_fr,
                                         a = "5",
                                         b = "500_plus")



# Contrib neighb question preprocessing
survey_df$ec_neighb_nl <- lut_likert_nl[survey_df$ec_neighb_nl]
survey_df$ec_neighb_fr <- lut_likert_fr[survey_df$ec_neighb_fr]

# Location question preprocessing
lut_loc_nl <- c("Brussel" = "Brussels",
                "Brussels" = "Brussels",
                "Vlanderen" = "Flanders",
                "Vlaanderen" = "Flanders",
                "Wallonië" = "Wallonia")

lut_loc_fr <- c("Bruxelles-Capitale" = "Brussels",
                "Flandre" = "Flanders",
                "Wallonie" = "Wallonia")

survey_df$ec_loc_nl <- lut_loc_nl[survey_df$ec_loc_nl]
survey_df$ec_loc_fr <- lut_loc_fr[survey_df$ec_loc_fr]

# Gender question preprocessing
lut_gen_eng <- c("Female" = "Female",
                 "Male" = "Male",
                 "Other/I prefer keep it for myself" = "Other")

lut_gen_nl <- c("een vrow" = "Female",
                "een man" = "Male",
                "anders/Ik hou het liever voor mezelf." = "Other")

lut_gen_fr <- c("Une femme" = "Female",
                "Un homme" = "Male",
                "Autre/Je préfère le garder pour moi" = "Other")

survey_df$ec_gender_eng <- lut_gen_eng[survey_df$ec_gender_eng]
survey_df$ec_gender_nl <- lut_gen_nl[survey_df$ec_gender_nl]
survey_df$ec_gender_fr <- lut_gen_fr[survey_df$ec_gender_fr]

# Age question preprocessing
lut_age_eng <- c("Under 14 years old." = "14_and_below",
                 "14-17 years old." = "14_17",
                 "18-24 years old." = "18_24",
                 "25-34 years old." = "25_34",
                 "35-44 years old." = "35_44",
                 "45-54 years old." = "45_54",
                 "55-64 years old." = "55_64",
                 "65-74 years old." = "65_74",
                 "75 years or older." = "75_plus")

lut_age_nl <- c("onder 14 jaar" = "14_and_below",
                "14-17 jaar" = "14_17",
                "18-24jaar" = "18_24",
                "25-34jaar" = "25_34",
                "35-44jaar" = "35_44",
                "45-54jaar" = "45_54",
                "55-64jaar" = "55_64",
                "65-74jaar" = "65_74",
                "75 jaar of ouder" = "75_plus")

lut_age_fr <- c("En dessous de 14 ans." = "14_and_below",
                "14-17 ans." = "14_17",
                "18-24 ans." = "18_24",
                "25-34 ans." = "25_34",
                "35-44 ans." = "35_44",
                "45-54 ans." = "45_54",
                "55-64 ans." = "55_64",
                "65-74 ans." = "65_74",
                "75 ans ou plus." = "75_plus")

survey_df$ec_age_eng <- lut_age_eng[survey_df$ec_age_eng]
survey_df$ec_age_nl <- lut_age_nl[survey_df$ec_age_nl]
survey_df$ec_age_fr <- lut_age_fr[survey_df$ec_age_fr]

# Education question preprocessing
lut_edu_eng <- c("Primary school or no schooling completed" = "Primary_or_None",
                 "High-School" = "High_school",
                 "Trade/technical/vocational training." = "Technical",
                 "Bachelor’s degree." = "Bachelor",
                 "Master’s degree." = "Master",
                 "Doctorate degree." = "PhD")

lut_edu_nl <- c("Lagere school of zonder diploma" = "Primary_or_None",
                "Humaniora" = "High_school",
                "Technische Humaniora" = "Technical",
                "Bachelor" = "Bachelor",
                "Master" = "Master",
                "Doctoraat" = "PhD")

lut_edu_nl <- c("Primaire ou sans diplôme" = "Primary_or_None",
                "Diplôme secondaire" = "High_school",
                "Diplôme secondaire technique" = "Technical",
                "Bachelier" = "Bachelor",
                "Master" = "Master",
                "Doctorat" = "PhD")

survey_df$ec_edu_eng <- lut_edu_eng[survey_df$ec_edu_eng]
survey_df$ec_edu_nl <- lut_edu_nl[survey_df$ec_edu_nl]
survey_df$ec_edu_fr <- lut_edu_nl[survey_df$ec_edu_fr]



# Merging columns from the different languages
all_cols <- names(survey_df)
eng_cols <- all_cols[str_detect(all_cols, pattern = "eng$")]
nl_cols <- all_cols[str_detect(all_cols, pattern = "nl$")]
fr_cols <- all_cols[str_detect(all_cols, pattern = "fr$")]

merged_cols <- str_replace(eng_cols,
                           pattern = "_eng$",
                           replacement = "")

temp_df <- tbl_df(data.frame(matrix(nrow = nrow(survey_df),
                             ncol = length(merged_cols))))
colnames(temp_df) <- merged_cols

survey_df <- tbl_df(cbind(survey_df, temp_df))

survey_df[is.na(survey_df)] <- ""

for (i in 1:length(merged_cols)) {
  m <- merged_cols[i]
  e <- eng_cols[i]
  n <- nl_cols[i]
  f <- fr_cols[i]
  survey_df[[m]] <- paste0(survey_df[[e]], survey_df[[n]], survey_df[[f]])
}

survey_df$lang <- factor(survey_df$lang)
survey_df$ec_gender <- factor(survey_df$ec_gender)

# Split survey_df_e/survey_df_c

survey_df_e <- survey_df %>%
  filter(grouping == "Active_member") %>% 
  select(date, lang, grouping:e_g6, ec_neighb:ec_edu)

temp_coln <- str_replace(names(survey_df_e), "^e_", "")
temp_coln <- str_replace(temp_coln, "^ec_", "")
temp_coln <- str_replace(temp_coln, "lang", "language")
names(survey_df_e) <- temp_coln


survey_df_c <- survey_df %>%
  filter(grouping != "Active_member") %>% 
  select(date, lang, grouping, c_interest:ec_edu)

temp_coln <- str_replace(names(survey_df_c), "^c_", "")
temp_coln <- str_replace(temp_coln, "^ec_", "")
temp_coln <- str_replace(temp_coln, "lang", "language")
names(survey_df_c) <- temp_coln

survey_df$lang <- factor(survey_df$lang,
                         levels = c("English", "Dutch", "French"))
survey_df$ec_gender <- factor(survey_df$ec_gender,
                              levels = c("Female", "Male", "Other"))

survey_df_e_j <- survey_df_e %>% select(date,
                                        language,
                                        grouping,
                                        loc,
                                        gender,
                                        age,
                                        edu) %>% mutate(resp_type = "Entrepreneur")

survey_df_c_j <- survey_df_c %>% select(date,
                                        language,
                                        grouping,
                                        loc,
                                        gender,
                                        age,
                                        edu) %>% mutate(resp_type = "Citizen")

survey_df_j <- survey_df_e_j %>% bind_rows(survey_df_c_j)

survey_df_j$resp_type <- factor(survey_df_j$resp_type,
                                levels = c("Entrepreneur", "Citizen"))
```


### Results

Now we can start analysing the data. Let's start with a bar plot showing the composition of the citizens.

```{r dpi = 150}
survey_df_j %>% 
  ggplot(aes(x = gender, fill = language)) +
  geom_bar() +
  facet_wrap(~ resp_type) +
  labs(title = "Composition of respondants",
       subtitle = "This is a subtitle") +
  theme_ipsum_rc() +
  scale_fill_ipsum()
```

The corresponding table with the values is given here:

```{r }
addmargins(table(survey_df_e$language, survey_df_e$gender) %>%
             cbind(table(survey_df_c$language, survey_df_c$gender))) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped","hover"),
                full_width = T) %>%
  column_spec(8, bold = T) %>% 
  row_spec(4, bold = T) %>%
  add_header_above(c(" ", "Entrepreneur" = 3, "Citizen" = 3, " " = 1))

```

